#include "test_cases.h"

namespace testcases {
using namespace testutil;

void RunScriptBuilderTransactionTests(TestContext& ctx)
{
	const std::string expectedScriptHex =
		"0D00030350340303000D000302102703000D000223220000000000000000000000000000000000000000000000000000000000000000000003000D000223220100AA53BE71FC41BC0889B694F4D6D03F7906A3D9A21705943CAF9632EEAFBB489503000D000408416C6C6F7747617303000D0004036761732D00012E010D0003010003000D00041D73797374656D2E6E657875732E70726F746F636F6C2E76657273696F6E03000D00042F50324B464579466576705166536157384734566A536D6857555A585234517247395951523148624D7054554370434C03000D00040A53696E676C65566F746503000D000409636F6E73656E7375732D00012E010D000223220100AA53BE71FC41BC0889B694F4D6D03F7906A3D9A21705943CAF9632EEAFBB489503000D0004085370656E6447617303000D0004036761732D00012E010B";
	const std::string expectedSignedTxHex =
		"07746573746E6574046D61696EFD42010D00030350340303000D000302102703000D000223220000000000000000000000000000000000000000000000000000000000000000000003000D000223220100AA53BE71FC41BC0889B694F4D6D03F7906A3D9A21705943CAF9632EEAFBB489503000D000408416C6C6F7747617303000D0004036761732D00012E010D0003010003000D00041D73797374656D2E6E657875732E70726F746F636F6C2E76657273696F6E03000D00042F50324B464579466576705166536157384734566A536D6857555A585234517247395951523148624D7054554370434C03000D00040A53696E676C65566F746503000D000409636F6E73656E7375732D00012E010D000223220100AA53BE71FC41BC0889B694F4D6D03F7906A3D9A21705943CAF9632EEAFBB489503000D0004085370656E6447617303000D0004036761732D00012E010BD202964909436F6E73656E737573010140F1C0410D49A5EDF0945B0EE9FAFDF6CA1FC315118D545E07824BEF1BA1F00881C29419648FD0B8200A356D21FAF45C60F4B77279D931CE4D732F5896E93BFE0D";
	const std::string knownTxHex =
		"07746573746E6574046D61696E03010203D2029649077061796C6F61640101404C033859A20A4FC2E469B3741FB05ACEDFEC24BFE92E07633680488665D79F916773FF40D0E81C4468E1C1487E6E1E6EEFDA5C5D7C53C15C4FB349C2349A1802";

	const ByteArray script = BuildConsensusSingleVoteScript();
	const std::string scriptHex = ToUpper(BytesToHex(script));
	const std::string expectedScript = ToUpper(expectedScriptHex);
	Report(ctx, scriptHex == expectedScript, "ScriptBuilder vector", scriptHex + " vs " + expectedScript);

	const std::string wif = "L5UEVHBjujaR1721aZM5Zm5ayjDyamMZS9W35RE9Y9giRkdf3dVx";
	const PhantasmaKeys keys = PhantasmaKeys::FromWIF(wif.c_str(), (int)wif.size());
	const Timestamp expiration(1234567890);
	const char payloadText[] = "Consensus";
	const ByteArray payload(payloadText, payloadText + sizeof(payloadText) - 1);

	Transaction tx("testnet", "main", script, expiration, payload);
	tx.Sign(keys);
	const ByteArray signedTx = tx.ToByteArray(true);
	const std::string signedHex = ToUpper(BytesToHex(signedTx));
	const std::string expectedSigned = ToUpper(expectedSignedTxHex);
	Report(ctx, signedHex == expectedSigned, "Transaction signed vector", signedHex + " vs " + expectedSigned);

	const ByteArray knownBytes = HexToBytes(knownTxHex);
	BinaryReader reader(knownBytes);
	const Transaction knownTx = Transaction::Unserialize(reader);
	const bool knownOk =
		knownTx.NexusName() == PHANTASMA_LITERAL("testnet") &&
		knownTx.ChainName() == PHANTASMA_LITERAL("main") &&
		ToUpper(BytesToHex(knownTx.Script())) == "010203" &&
		ToUpper(BytesToHex(knownTx.Payload())) == "7061796C6F6164" &&
		knownTx.Expiration().Value == 1234567890u &&
		knownTx.Signatures().size() == 1;
	Report(ctx, knownOk, "Transaction unserialize");
}

} // namespace testcases
